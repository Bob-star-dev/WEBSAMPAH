<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Analitik - Bak Sampah Pintar</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div>
                <h1 class="header-title">Analitik Data</h1>
                <p class="header-subtitle">Analisis lengkap penggunaan bak sampah</p>
            </div>
            <div class="header-icon"><i class="fas fa-chart-bar"></i></div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Period Selection -->
        <div class="card fade-in">
            <div class="card-header">
                <h2 class="card-title">Pilih Periode</h2>
                <div class="card-icon"><i class="fas fa-calendar-day"></i></div>
            </div>
            <div class="chart-controls">
                <button class="chart-btn active" onclick="showChart('harian')" data-period="harian">
                    Harian
                </button>
                <button class="chart-btn" onclick="showChart('mingguan')" data-period="mingguan">
                    Mingguan
                </button>
                <button class="chart-btn" onclick="showChart('bulanan')" data-period="bulanan">
                    Bulanan
                </button>
            </div>
        </div>

        <!-- Chart Container -->
        <div class="chart-container fade-in">
            <div class="card-header" style="margin-bottom: var(--spacing-md);">
                <h2 class="card-title" id="chartTitle">Grafik Harian</h2>
                <div class="card-icon"><i class="fas fa-chart-line"></i></div>
            </div>
            <div class="chart-wrapper">
                <canvas id="analyticsChart"></canvas>
            </div>
        </div>

        <!-- Statistics Summary -->
        <div class="card fade-in">
            <div class="card-header">
                <h2 class="card-title">Ringkasan Statistik</h2>
                <div class="card-icon"><i class="fas fa-clipboard-list"></i></div>
            </div>
            <div id="statisticsSummary">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Insights -->
        <div class="card fade-in">
            <div class="card-header">
                <h2 class="card-title">Insight & Analisis</h2>
                <div class="card-icon"><i class="fas fa-lightbulb"></i></div>
            </div>
            <div id="insights">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item" data-page="dashboard">
            <div class="nav-icon"><i class="fas fa-home"></i></div>
            <div class="nav-label">Dashboard</div>
        </a>
        <a href="analitik.html" class="nav-item active" data-page="analitik">
            <div class="nav-icon"><i class="fas fa-chart-bar"></i></div>
            <div class="nav-label">Analitik</div>
        </a>
        <a href="rekomendasi.html" class="nav-item" data-page="rekomendasi">
            <div class="nav-icon"><i class="fas fa-lightbulb"></i></div>
            <div class="nav-label">Rekomendasi</div>
        </a>
        <a href="profil.html" class="nav-item" data-page="profil">
            <div class="nav-icon"><i class="fas fa-user"></i></div>
            <div class="nav-label">Profil</div>
        </a>
    </nav>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="data.js"></script>
    <script src="app.js"></script>
    <script>
        // Analytics specific JavaScript
        let currentChart = null;
        let currentPeriod = 'harian';

        function loadAnalytics() {
            // Initialize chart
            currentChart = AppJS.initChart('analyticsChart', 'bar');
            
            // Show default chart
            showChart('harian');
            
            // Load statistics summary
            loadStatisticsSummary();
            
            // Load insights
            loadInsights();
        }

        function showChart(period) {
            currentPeriod = period;
            
            // Update button active state
            document.querySelectorAll('.chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-period="${period}"]`).classList.add('active');
            
            // Update chart title
            const titles = {
                'harian': 'Grafik Harian (7 Hari Terakhir)',
                'mingguan': 'Grafik Mingguan (4 Minggu Terakhir)',
                'bulanan': 'Grafik Bulanan (12 Bulan Terakhir)'
            };
            document.getElementById('chartTitle').textContent = titles[period];
            
            // Get and display chart data
            let labels = [];
            let organicData = [];
            let nonOrganicData = [];
            
            if (period === 'harian') {
                const allData = DataManager.getAllData();
                const sortedDates = Object.keys(allData).sort((a, b) => new Date(a) - new Date(b)).slice(-7);
                
                sortedDates.forEach(dateStr => {
                    const data = allData[dateStr];
                    labels.push(DataManager.formatDateShort(dateStr));
                    organicData.push(data.organic || 0);
                    nonOrganicData.push(data.nonOrganic || 0);
                });
            } else if (period === 'mingguan') {
                const weeklyData = DataManager.getWeeklyData();
                weeklyData.forEach(week => {
                    labels.push(week.label);
                    organicData.push(week.organic);
                    nonOrganicData.push(week.nonOrganic);
                });
            } else if (period === 'bulanan') {
                const monthlyData = DataManager.getMonthlyData();
                monthlyData.forEach(month => {
                    labels.push(month.label);
                    organicData.push(month.organic);
                    nonOrganicData.push(month.nonOrganic);
                });
            }
            
            // Update chart
            if (currentChart) {
                AppJS.updateChart(currentChart, labels, organicData, nonOrganicData);
            } else {
                currentChart = AppJS.initChart('analyticsChart', 'bar');
                setTimeout(() => {
                    AppJS.updateChart(currentChart, labels, organicData, nonOrganicData);
                }, 100);
            }
        }

        function loadStatisticsSummary() {
            const stats = DataManager.getStats();
            const todayData = DataManager.getTodayData();
            
            const summaryHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); margin-top: var(--spacing-md);">
                    <div style="padding: var(--spacing-md); background: var(--bg-glass); border-radius: var(--radius-md); text-align: center;">
                        <div style="font-size: 0.875rem; color: var(--text-light); margin-bottom: var(--spacing-xs);">Total Organik</div>
                        <div style="font-size: 1.75rem; font-weight: 700; color: var(--organic-color);">${stats.totalOrganic}</div>
                    </div>
                    <div style="padding: var(--spacing-md); background: var(--bg-glass); border-radius: var(--radius-md); text-align: center;">
                        <div style="font-size: 0.875rem; color: var(--text-light); margin-bottom: var(--spacing-xs);">Total Non-Organik</div>
                        <div style="font-size: 1.75rem; font-weight: 700; color: var(--nonorganic-color);">${stats.totalNonOrganic}</div>
                    </div>
                    <div style="padding: var(--spacing-md); background: var(--bg-glass); border-radius: var(--radius-md); text-align: center;">
                        <div style="font-size: 0.875rem; color: var(--text-light); margin-bottom: var(--spacing-xs);">Total Sampah</div>
                        <div style="font-size: 1.75rem; font-weight: 700; color: var(--text-primary);">${stats.total}</div>
                    </div>
                    <div style="padding: var(--spacing-md); background: var(--bg-glass); border-radius: var(--radius-md); text-align: center;">
                        <div style="font-size: 0.875rem; color: var(--text-light); margin-bottom: var(--spacing-xs);">Rata-rata/hari</div>
                        <div style="font-size: 1.75rem; font-weight: 700; color: var(--success-color);">${stats.avgDaily}</div>
                    </div>
                </div>
                <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
                        <span style="color: var(--text-secondary);">Persentase Organik</span>
                        <span style="font-weight: 600; color: var(--organic-color);">${stats.organicPercentage}%</span>
                    </div>
                    <div style="height: 8px; background: var(--bg-glass); border-radius: var(--radius-full); overflow: hidden;">
                        <div style="height: 100%; width: ${stats.organicPercentage}%; background: var(--organic-gradient); border-radius: var(--radius-full);"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: var(--spacing-md); margin-bottom: var(--spacing-sm);">
                        <span style="color: var(--text-secondary);">Persentase Non-Organik</span>
                        <span style="font-weight: 600; color: var(--nonorganic-color);">${stats.nonOrganicPercentage}%</span>
                    </div>
                    <div style="height: 8px; background: var(--bg-glass); border-radius: var(--radius-full); overflow: hidden;">
                        <div style="height: 100%; width: ${stats.nonOrganicPercentage}%; background: var(--nonorganic-gradient); border-radius: var(--radius-full);"></div>
                    </div>
                </div>
            `;
            
            document.getElementById('statisticsSummary').innerHTML = summaryHTML;
        }

        function loadInsights() {
            const stats = DataManager.getStats();
            const allData = DataManager.getAllData();
            const sortedDates = Object.keys(allData).sort((a, b) => new Date(a) - new Date(b));
            const last7Days = sortedDates.slice(-7);
            
            let totalLast7 = { organic: 0, nonOrganic: 0 };
            last7Days.forEach(dateStr => {
                const data = allData[dateStr];
                totalLast7.organic += data.organic || 0;
                totalLast7.nonOrganic += data.nonOrganic || 0;
            });
            
            const avgLast7 = (totalLast7.organic + totalLast7.nonOrganic) / 7;
            const todayData = DataManager.getTodayData();
            const todayTotal = todayData.organic + todayData.nonOrganic;
            
            let insightsHTML = '<div style="display: flex; flex-direction: column; gap: var(--spacing-md);">';
            
            // Insight 1: Today vs Average
            if (todayTotal > avgLast7 * 1.2) {
                insightsHTML += `
                    <div class="recommendation-card">
                        <div class="recommendation-header">
                            <div class="recommendation-icon"><i class="fas fa-exclamation-triangle"></i></div>
                            <div class="recommendation-title">Penggunaan Tinggi Hari Ini</div>
                        </div>
                        <div class="recommendation-text">
                            Hari ini Anda telah membuang ${todayTotal} sampah, lebih tinggi ${((todayTotal / avgLast7 - 1) * 100).toFixed(0)}% dari rata-rata 7 hari terakhir.
                        </div>
                    </div>
                `;
            } else if (todayTotal < avgLast7 * 0.8) {
                insightsHTML += `
                    <div class="recommendation-card">
                        <div class="recommendation-header">
                            <div class="recommendation-icon"><i class="fas fa-thumbs-up"></i></div>
                            <div class="recommendation-title">Penggunaan Rendah Hari Ini</div>
                        </div>
                        <div class="recommendation-text">
                            Bagus! Hari ini penggunaan sampah lebih rendah dari rata-rata. Tetap konsisten!
                        </div>
                    </div>
                `;
            }
            
            // Insight 2: Ratio
            const organicRatio = stats.totalOrganic / stats.total * 100;
            if (organicRatio < 40) {
                insightsHTML += `
                    <div class="recommendation-card">
                        <div class="recommendation-header">
                            <div class="recommendation-icon"><i class="fas fa-leaf"></i></div>
                            <div class="recommendation-title">Rasio Organik Rendah</div>
                        </div>
                        <div class="recommendation-text">
                            Rasio sampah organik Anda ${organicRatio.toFixed(1)}%. Pertimbangkan untuk menggunakan lebih banyak produk organik.
                        </div>
                    </div>
                `;
            } else if (organicRatio > 70) {
                insightsHTML += `
                    <div class="recommendation-card">
                        <div class="recommendation-header">
                            <div class="recommendation-icon"><i class="fas fa-check-circle"></i></div>
                            <div class="recommendation-title">Rasio Organik Sangat Baik</div>
                        </div>
                        <div class="recommendation-text">
                            Luar biasa! ${organicRatio.toFixed(1)}% sampah Anda adalah organik. Pola konsumsi yang sangat baik!
                        </div>
                    </div>
                `;
            }
            
            // Insight 3: Trend
            if (last7Days.length >= 3) {
                const firstHalf = last7Days.slice(0, Math.floor(last7Days.length / 2));
                const secondHalf = last7Days.slice(Math.floor(last7Days.length / 2));
                
                let firstHalfTotal = 0;
                let secondHalfTotal = 0;
                
                firstHalf.forEach(dateStr => {
                    const data = allData[dateStr];
                    firstHalfTotal += (data.organic || 0) + (data.nonOrganic || 0);
                });
                
                secondHalf.forEach(dateStr => {
                    const data = allData[dateStr];
                    secondHalfTotal += (data.organic || 0) + (data.nonOrganic || 0);
                });
                
                if (secondHalfTotal > firstHalfTotal * 1.2) {
                    insightsHTML += `
                        <div class="recommendation-card">
                            <div class="recommendation-header">
                                <div class="recommendation-icon"><i class="fas fa-arrow-up"></i></div>
                                <div class="recommendation-title">Tren Meningkat</div>
                            </div>
                            <div class="recommendation-text">
                                Penggunaan sampah menunjukkan tren meningkat. Evaluasi pola konsumsi Anda.
                            </div>
                        </div>
                    `;
                } else if (secondHalfTotal < firstHalfTotal * 0.8) {
                    insightsHTML += `
                        <div class="recommendation-card">
                            <div class="recommendation-header">
                                <div class="recommendation-icon"><i class="fas fa-arrow-down"></i></div>
                                <div class="recommendation-title">Tren Menurun</div>
                            </div>
                            <div class="recommendation-text">
                                Bagus! Penggunaan sampah menunjukkan tren menurun. Tetap pertahankan!
                            </div>
                        </div>
                    `;
                }
            }
            
            insightsHTML += '</div>';
            
            document.getElementById('insights').innerHTML = insightsHTML || '<div class="empty-state"><div class="empty-text">Belum ada insight tersedia</div></div>';
        }

        // Load analytics on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAnalytics();
        });
    </script>
</body>
</html>

